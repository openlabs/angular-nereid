"use strict";angular.module("openlabs.angular-nereid-auth",["base64"]).config(["$httpProvider",function(n){delete n.defaults.headers.common["X-Requested-With"],n.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).config(["$httpProvider",function(n){n.interceptors.push(function(n,e,i){return{responseError:function(e){return 401===e.status&&i.$broadcast("nereid-auth:loginRequired",e),n.reject(e)}}})}]).factory("nereid",[function(){var n="",e={setApiBasePath:function(e){n=e},buildUrl:function(e){return"/"!=e[0]&&console.warn('path when using buildUrl should begin with "/"'),n+e}};return e}]).factory("nereidAuth",["$http","$base64","$rootScope","nereid",function(n,e,i,t){var r="/login/token",o="/me",s=localStorage.getItem("token"),u={},a=function(e){return e?void(n.defaults.headers.common.Authorization="Token "+e.toString()):void delete n.defaults.headers.common.Authorization},c=function(){return n.get(t.buildUrl(o)).success(function(n){angular.extend(u,n)})},d=function(){return s?!0:!1};s&&(a(s),c().error(function(n,e){401==e&&l()}));var f=function(n){n?localStorage.setItem("token",n):localStorage.removeItem("token"),a(n),s=n,n&&c()},l=function(){f(null),u={},i.$broadcast("nereid-auth:logout")},h=function(o,s){var a=e.encode(o+":"+s);return n.post(t.buildUrl(r),{},{headers:{Authorization:"Basic "+a}}).success(function(n){u=n.user,f(n.token),i.$broadcast("nereid-auth:login",n)}).error(function(n,e,t){i.$broadcast("nereid-auth:loginFailed",{reason:n,status:e,headers:t()}),l()})},m=function(n){if(!d()||!u.permissions||!n)return!1;for(var e in n)if(-1==u.permissions.indexOf(n[e]))return!1;return!0},g=function(n){if(!d()||!u.permissions||!n)return!1;for(var e in n)if(-1!=u.permissions.indexOf(n[e]))return!0;return!1},v={setLoginEndpoint:function(n){r=n},setUserInfoEndpoint:function(n){o=n},setapiBasePath:function(n){console.warn("WARNING: Setting API basepath from nereid-auth will be removed: https://github.com/openlabs/angular-nereid-auth/issues/7"),t.setApiBasePath(n)},hasAnyPermission:g,hasAllPermissions:m,login:h,logoutUser:l,user:function(){return u},refreshUserInfo:c,isLoggedIn:d};return v}]).directive("showIfAuth",["$animate","nereidAuth",function(n,e){return function(i,t){i.$watch(function(){return e.isLoggedIn()},function(){n[e.isLoggedIn()?"removeClass":"addClass"](t,"ng-hide")})}}]).directive("hideIfAuth",["$animate","nereidAuth",function(n,e){return function(i,t){i.$watch(function(){return e.isLoggedIn()},function(){n[e.isLoggedIn()?"addClass":"removeClass"](t,"ng-hide")})}}]).directive("showIfAnyPermission",["$animate","nereidAuth",function(n,e){return function(i,t,r){var o=i.$eval(r.showIfAnyPermission);i.$watch(function(){return e.user().permissions},function(){n[e.hasAnyPermission(o)?"removeClass":"addClass"](t,"ng-hide")})}}]).directive("showIfAllPermissions",["$animate","nereidAuth",function(n,e){return function(i,t,r){var o=i.$eval(r.showIfAllPermissions);i.$watch(function(){return e.user().permissions},function(){n[e.hasAllPermissions(o)?"removeClass":"addClass"](t,"ng-hide")})}}]).directive("hideIfAnyPermission",["$animate","nereidAuth",function(n,e){return function(i,t,r){var o=i.$eval(r.hideIfAnyPermission);i.$watch(function(){return e.user().permissions},function(){n[e.hasAnyPermission(o)?"addClass":"removeClass"](t,"ng-hide")})}}]).directive("hideIfAllPermissions",["$animate","nereidAuth",function(n,e){return function(i,t,r){var o=i.$eval(r.hideIfAllPermissions);i.$watch(function(){return e.user().permissions},function(){n[e.hasAllPermissions(o)?"addClass":"removeClass"](t,"ng-hide")})}}]).directive("nereidAuth",function(n){return{restrict:"A",link:function(e){e.logout=function(){n.logoutUser()}}}});